<script src="vendor/core_ext.js"></script>
<script src="vendor/store.js"></script>
<script src="vendor/jquery-1.4.2.js"></script>
<script>

  var Watcher = {
    urls: function(){
      return store.get('urls') || []
    },
    hasUrl: function(url){
      if (!url.match(/.*craigslist.org.*\/search\//))
        return null
      return (this.urls()).indexOf(url) > -1
    },
    addUrl: function(url){
      var urls = store.get('urls') || []
      if (urls.indexOf(url) == -1)
        urls.push(url)
      store.set('urls', urls)
    },
    removeUrl: function(url){
      var found = false

      var urls = store.get('urls') || []
      if (urls.indexOf(url) > -1) {
        found = true
        urls.splice( urls.indexOf(url), 1 )
      }
      store.set('urls', urls)

      var watches = store.get('watches') || {}
      delete watches[ url ]
      store.set('watches', watches)

      return found
    },
    checkUrl: function(url, cb){
      this.fetch(url, function(response) {
        var links = response.links
        var latestSeen = 0

        if (links && links.length) {
          latestSeen = links[0].match(/(\d+)\.html$/)[1]
        }

        var watches = store.get('watches') || {}
        var watch = watches[url] || {}
        watch.latestSeen = latestSeen
        watch.lastUpdated = new Date().getTime()

        if (!watch.latestRead) {
          watch.latestRead = latestSeen
          watch.numUnread = 0
        } else {
          watch.numUnread = 0
          var num_older = 0
          for(var i=0; i<links.length; i++) {
            var id = links[i].match(/(\d+)\.html$/)[1]
            if (id <= watch.latestRead) {
              if (id == watch.latestRead) break
              num_older += 1
              if (num_older > 2) break
            }
            watch.numUnread += 1
          }
        }
        watches[url] = watch
        store.set('watches', watches)

        cb(watch)
      })
    },
    numUnread: function(){
      var watches = store.get('watches') || {}
      var num = 0
      this.urls().forEach(function(url){
        num += (watches[url] || {}).numUnread || 0
      })
      return num
    },
    fetch: function(url, cb){
      console.log('fetching', url)
      $.ajax({
        url: url,
        cache: url.match(/\d+\.html$/) ? true : false,
        error: function(e){
          console.log('error', url, e)
        },
        success: function(data){
          console.log('fetched', url, data.length)
          var doc = $('<div>').append($(data).not('script')), result = {}

          /* result page */
          if (url.match(/\d+\.html$/)) {
            var mailto = doc.find('a[href*="mailto"]'),
                maps = doc.find('a:contains("google map")'),
                srcs = doc.find('img').map(function(){ return this.src }),
                images = $.makeArray(srcs).unique()

            result = {
              title: doc.find('h2').text(),
              email: mailto.length ? mailto[0].href : null,
              address: maps.length ? decodeURIComponent(maps[0].href.match(/q=(.*)$/)[1]) : null,
              images: images
            }

          /* listing page */
          } else {
            var results = doc.find('p'),
                hrefs = results.find('a').map(function(){ return this.href }),
                links = $.makeArray(hrefs).unique()

            result = {
              links: links
            }
          }

          cb(result)
        }
      })
    }
  }

  var updateTabAction = function(tab){
    var url = tab.url
    var saveable = Watcher.hasUrl(url) != null

    if (saveable) {
      var saved = Watcher.hasUrl(url) == true

      chrome.browserAction.setPopup({
        tabId: tab.id,
        popup: ''
      })
      chrome.browserAction.setTitle({
        tabId: tab.id,
        title: saved ? 'Stop watching this page' : 'Watch this page for new listings'
      })
      chrome.browserAction.setBadgeBackgroundColor({
        tabId: tab.id,
        color: saved ? [255,0,0,225] : [0,255,0,225]
      })
      chrome.browserAction.setBadgeText({
        tabId: tab.id,
        text: saved ? '--' : '+'
      })
    }
  }

  chrome.browserAction.onClicked.addListener(function(tab){
    var url = tab.url
    if (Watcher.hasUrl(url) == false) {
      Watcher.addUrl(url)
    } else if (Watcher.hasUrl(url) == true) {
      Watcher.removeUrl(url)
    }
    updateTabAction(tab)
  })

  chrome.extension.onRequest.addListener(
    function(request, sender, sendResponse) {
      console.log(sender.tab ?  "from a content script:" + sender.tab.url : "from the extension")

      if (request.type == "search_page") {
        if (sender.tab)
          updateTabAction(sender.tab)
        sendResponse({})
      } else if (request.type == "fetch") {
        Watcher.fetch(request.url, function(result){
          sendResponse(result)
        })
      } else {
        sendResponse({})
      }
    }
  )

  var checkWatcherTimeout = null
  var checkWatchers = function(){
    var urls = Watcher.urls()
    var num_left = urls.length

    urls.forEach(function(url){
      Watcher.checkUrl(url, function(watch){
        console.log('got', watch)
        num_left -= 1

        var num = Watcher.numUnread()
        chrome.browserAction.setBadgeBackgroundColor({color: [255,0,0,155]})
        chrome.browserAction.setBadgeText({text: num ? (''+num) : ''})

        if (num_left == 0 && !checkWatcherTimeout) {
          console.log('rescheduling')
          checkWatcherTimeout = setTimeout(function(){ checkWatcherTimeout=null; checkWatchers() }, 5*60*1000)
        }
      })
    })
  }
  checkWatchers()

</script>
